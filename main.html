import React, { useState, useRef, useEffect } from 'react';
import { Upload, Download, Palette } from 'lucide-react';

export default function ImageBorderTool() {
  const [image, setImage] = useState(null);
  const [borderType, setBorderType] = useState('rainbow');
  const [borderWidth, setBorderWidth] = useState(20);
  const [customColor, setCustomColor] = useState('#000000');
  const [rainbowRepeat, setRainbowRepeat] = useState(3);
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          setImage(img);
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    }
  };

  useEffect(() => {
    if (image && canvasRef.current) {
      drawImageWithBorder();
    }
  }, [image, borderType, borderWidth, customColor, rainbowRepeat]);

  const drawImageWithBorder = () => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    
    const totalWidth = image.width + borderWidth * 2;
    const totalHeight = image.height + borderWidth * 2;
    
    canvas.width = totalWidth;
    canvas.height = totalHeight;

    // Draw border based on type
    if (borderType === 'rainbow') {
      drawRainbowBorder(ctx, totalWidth, totalHeight);
    } else if (borderType === 'white') {
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, totalWidth, totalHeight);
    } else if (borderType === 'black') {
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, totalWidth, totalHeight);
    } else if (borderType === 'custom') {
      ctx.fillStyle = customColor;
      ctx.fillRect(0, 0, totalWidth, totalHeight);
    }

    // Draw image on top
    ctx.drawImage(image, borderWidth, borderWidth);
  };

  const drawRainbowBorder = (ctx, width, height) => {
    // Create a continuous gradient around the entire border with repeating rainbow
    for (let i = 0; i < borderWidth; i++) {
      ctx.beginPath();
      
      // Create path for this layer of border
      const offset = i;
      ctx.rect(offset, offset, width - offset * 2, height - offset * 2);
      
      // Apply repeating rainbow gradient
      const gradient = ctx.createConicGradient(0, width / 2, height / 2);
      
      // Calculate color stops for repeating pattern
      const repeatCount = rainbowRepeat;
      for (let r = 0; r < repeatCount; r++) {
        const baseStop = r / repeatCount;
        const stopSize = 1 / repeatCount;
        
        gradient.addColorStop(baseStop, '#FF0000');
        gradient.addColorStop(baseStop + stopSize * 0.14, '#FF7F00');
        gradient.addColorStop(baseStop + stopSize * 0.28, '#FFFF00');
        gradient.addColorStop(baseStop + stopSize * 0.42, '#00FF00');
        gradient.addColorStop(baseStop + stopSize * 0.57, '#0000FF');
        gradient.addColorStop(baseStop + stopSize * 0.71, '#4B0082');
        gradient.addColorStop(baseStop + stopSize * 0.85, '#9400D3');
        if (r < repeatCount - 1) {
          gradient.addColorStop(baseStop + stopSize, '#FF0000');
        }
      }
      gradient.addColorStop(1, '#FF0000');
      
      ctx.strokeStyle = gradient;
      ctx.lineWidth = 1;
      ctx.stroke();
    }
  };

  const handleDownload = () => {
    const canvas = canvasRef.current;
    canvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = 'image-with-border.png';
      link.href = url;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }, 'image/png');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 p-8">
      <div className="max-w-6xl mx-auto">
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Công cụ thêm viền ảnh</h1>
          <p className="text-gray-600">Tải ảnh lên và thêm viền màu theo ý thích</p>
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          <div className="mb-6">
            <input
              type="file"
              ref={fileInputRef}
              onChange={handleImageUpload}
              accept="image/*"
              className="hidden"
            />
            <button
              onClick={() => fileInputRef.current.click()}
              className="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white py-4 px-6 rounded-xl font-semibold flex items-center justify-center gap-2 hover:from-purple-600 hover:to-blue-600 transition-all shadow-lg"
            >
              <Upload size={24} />
              Tải ảnh lên
            </button>
          </div>

          {image && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-3">
                    <Palette className="inline mr-2" size={18} />
                    Loại viền
                  </label>
                  <div className="space-y-2">
                    <button
                      onClick={() => setBorderType('rainbow')}
                      className={`w-full p-3 rounded-lg border-2 transition-all ${
                        borderType === 'rainbow'
                          ? 'border-purple-500 bg-purple-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <span className="font-medium">Cầu vồng 7 màu</span>
                        <div className="flex gap-1">
                          {['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3'].map((c, i) => (
                            <div key={i} className="w-4 h-4 rounded" style={{ backgroundColor: c }}></div>
                          ))}
                        </div>
                      </div>
                    </button>
                    <button
                      onClick={() => setBorderType('white')}
                      className={`w-full p-3 rounded-lg border-2 transition-all ${
                        borderType === 'white'
                          ? 'border-purple-500 bg-purple-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <span className="font-medium">Trắng</span>
                        <div className="w-8 h-4 rounded bg-white border border-gray-300"></div>
                      </div>
                    </button>
                    <button
                      onClick={() => setBorderType('black')}
                      className={`w-full p-3 rounded-lg border-2 transition-all ${
                        borderType === 'black'
                          ? 'border-purple-500 bg-purple-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <span className="font-medium">Đen</span>
                        <div className="w-8 h-4 rounded bg-black"></div>
                      </div>
                    </button>
                    <button
                      onClick={() => setBorderType('custom')}
                      className={`w-full p-3 rounded-lg border-2 transition-all ${
                        borderType === 'custom'
                          ? 'border-purple-500 bg-purple-50'
                          : 'border-gray-200 hover:border-gray-300'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <span className="font-medium">Màu tùy chỉnh</span>
                        <input
                          type="color"
                          value={customColor}
                          onChange={(e) => setCustomColor(e.target.value)}
                          className="w-12 h-8 rounded cursor-pointer"
                          onClick={(e) => e.stopPropagation()}
                        />
                      </div>
                    </button>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-3">
                    Độ dày viền: {borderWidth}px
                  </label>
                  <input
                    type="range"
                    min="5"
                    max="100"
                    value={borderWidth}
                    onChange={(e) => setBorderWidth(Number(e.target.value))}
                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>5px</span>
                    <span>100px</span>
                  </div>

                  {borderType === 'rainbow' && (
                    <div className="mt-6">
                      <label className="block text-sm font-semibold text-gray-700 mb-3">
                        Số lần lặp cầu vồng: {rainbowRepeat}
                      </label>
                      <input
                        type="range"
                        min="1"
                        max="10"
                        value={rainbowRepeat}
                        onChange={(e) => setRainbowRepeat(Number(e.target.value))}
                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-purple-500"
                      />
                      <div className="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 lần</span>
                        <span>10 lần</span>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              <button
                onClick={handleDownload}
                className="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white py-4 px-6 rounded-xl font-semibold flex items-center justify-center gap-2 hover:from-green-600 hover:to-teal-600 transition-all shadow-lg"
              >
                <Download size={24} />
                Tải ảnh xuống
              </button>
            </div>
          )}
        </div>

        {image && (
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Xem trước</h2>
            <div className="flex justify-center overflow-auto">
              <canvas ref={canvasRef} className="max-w-full h-auto shadow-lg rounded-lg" />
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
